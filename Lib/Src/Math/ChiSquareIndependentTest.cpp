#include "pch.h"
#include <Math/Statistic.h>

// Chisquare Independency test. Return p-value for null-hypothesis: Rows in m are indepenpent (of row-number)
// p close to 1 is good for the null-hypothesis, close to 0 is bad. (close to 0 usually < 0.05 (significance level)
// Assume v.size == expected.size, and both are >= 2. and all elements of expected > 0
double chiSquareIndependencyTest(const Matrix &m) {
  const MatrixDimension &dim = m.getDimension();
  const size_t           rows = dim.rowCount;
  const size_t           cols = dim.columnCount;
  if((rows < 2) || (cols < 2)) {
    throwInvalidArgumentException(__TFUNCTION__, _T("m:%s"), m.getDimensionString().cstr());
  }
  CompactDoubleArray rowSum(rows), colSum(cols);
  double totalSum = 0;
  for(size_t r = 0; r < rows; r++) {
    double sum = 0;
    for(size_t c = 0; c < cols; c++) {
      sum += (double)m(r, c);
    }
    rowSum.add(sum);
    totalSum += sum;
  }
  for(size_t c = 0; c < cols; c++) {
    double sum = 0;
    for(size_t r = 0; r < rows; r++) {
      sum += (double)m(r, c);
    }
    colSum.add(sum);
  }
  double q = 0;
  for(size_t r = 0; r < rows; r++) {
    for(size_t c = 0; c < cols; c++) {
      const double expected = (rowSum[r] * colSum[c]) / totalSum;
      q += sqr((double)m(r, c) - expected) / expected;
    }
  }
  return 1.0 - (double)chiSquaredDistribution((double)(rows - 1)*(cols - 1), q);
}
